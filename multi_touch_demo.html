<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Multi-Touch Visualizer v2 - iPad æµ‹è¯•ï¼ˆæ­£æ–¹å½¢åƒç´  + è¶…éšæœºï¼‰</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        body {
            background: black;
            touch-action: none;
            font-family: -apple-system, sans-serif;
        }
        canvas {
            display: block;
            cursor: none;
        }
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            color: lime;
            font-size: 14px;
            z-index: 10;
            pointer-events: none;
            user-select: none;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 8px;
        }
        @media (max-width: 768px) {
            #info { font-size: 12px; }
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>
    <div id="info">
        <div>æ‰‹æŒ‡æ•°é‡: <span id="touchCount">0</span></div>
        <div>åŠ›åº¦æ€»å’Œ: <span id="totalForce">0</span></div>
        <div>ğŸ’¡ å¤šæŒ‡è§¦æ‘¸ + æŒ‰å‹æµ‹è¯•ï¼<br>åƒç´ å·²ç»Ÿä¸€æ­£æ–¹å½¢ï¼Œéšæœºè¶…è‡ªç„¶</div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const touchCountEl = document.getElementById('touchCount');
        const totalForceEl = document.getElementById('totalForce');

        // ç½‘æ ¼é…ç½®ï¼š200x200 è¶…ç²¾ç»†æ­£æ–¹å½¢
        const GRID_SIZE = 200;
        let pixelSize = 1;
        let offsetX = 0, offsetY = 0;
        let touches = new Map(); // touchId -> {x,y,gridX,gridY,force,radius,seed}

        // åŸºç¡€è§¦æ§å‚æ•°
        const BASE_RADIUS = 5.0;
        const CORE_SIZE = 1.0;

        // æ”¹è¿›å™ªå£°ï¼šå¤šå±‚ Perlin-like + per-touch seed
        function noise(x, y, seed = 0) {
            let n = 0;
            let amp = 1;
            for (let i = 0; i < 3; i++) { // å¤šå±‚å™ªå£° = æ›´è‡ªç„¶
                x += seed * 0.1;
                y += seed * 0.17;
                n += amp * ((Math.sin(x * 12.9898 + y * 78.233 + seed) * 43758.5453) % 1);
                amp *= 0.5;
                x *= 2; y *= 2;
            }
            return (n - 0.5) * 0.4 + 0.8; // 0.4~1.2 å˜å¼‚
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            const size = Math.min(canvas.width, canvas.height);
            pixelSize = size / GRID_SIZE;
            offsetX = (canvas.width - size) / 2;
            offsetY = (canvas.height - size) / 2;
        }

        function updateTouches(event) {
            event.preventDefault();
            touches.clear();
            let totalForce = 0;
            for (let i = 0; i < event.touches.length; i++) {
                const touch = event.touches[i];
                const rect = canvas.getBoundingClientRect();
                const x = ((touch.clientX - rect.left) - offsetX) / pixelSize;
                const y = ((touch.clientY - rect.top) - offsetY) / pixelSize;
                const gridX = Math.floor(x);
                const gridY = Math.floor(y);
                const force = touch.force || 1.0;
                const radius = Math.max(2, (touch.radiusX || 20) * 0.15); // çœŸå®åŠå¾„
                const seed = (touch.identifier * 123.456) % 10000; // å”¯ä¸€ç§å­
                touches.set(touch.identifier, { x, y, gridX, gridY, force, radius, seed });
                totalForce += force;
            }
            touchCountEl.textContent = touches.size;
            totalForceEl.textContent = totalForce.toFixed(1);
            render();
        }

        function render() {
            // æ¸…å±é»‘åº•
            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // åªç»˜åˆ¶ç½‘æ ¼åŒºåŸŸ
            const gridLeft = offsetX;
            const gridTop = offsetY;
            const gridW = GRID_SIZE * pixelSize;
            const gridH = gridW; // æ­£æ–¹å½¢

            // ç»˜åˆ¶æ¯ä¸ªåƒç´ ï¼ˆä¼˜åŒ–ï¼šåªæ¸²æŸ“æ´»è·ƒåŒºåŸŸï¼‰
            for (let gy = 0; gy < GRID_SIZE; gy++) {
                for (let gx = 0; gx < GRID_SIZE; gx++) {
                    let maxBright = 0;
                    let coreTouch = null;

                    touches.forEach(touch => {
                        const dx = gx - touch.gridX;
                        const dy = gy - touch.gridY;
                        const dist = Math.sqrt(dx*dx + dy*dy);
                        const touchR = touch.radius * BASE_RADIUS; // åŠ¨æ€åŠå¾„

                        if (dist < CORE_SIZE) {
                            coreTouch = touch;
                            maxBright = 1.0;
                            return;
                        }

                        if (dist < touchR) {
                            let bright = (1.0 - dist / touchR) * touch.force;
                            // **è¶…éšæœº**ï¼šper-touch å¤šå±‚å™ªå£°
                            bright *= noise(gx * 0.08, gy * 0.08, touch.seed);
                            maxBright = Math.max(maxBright, bright);
                        }
                    });

                    if (maxBright > 0.05) { // é˜ˆå€¼ä¼˜åŒ–æ€§èƒ½
                        const px = gridLeft + gx * pixelSize;
                        const py = gridTop + gy * pixelSize;

                        // å¡«å……ï¼šæ·±æµ…éšæœºç°ç™½
                        const gray = Math.floor(maxBright * 255);
                        ctx.fillStyle = `rgb(${gray},${gray},${gray})`;
                        ctx.fillRect(px, py, pixelSize, pixelSize);

                        // **æ ¸å¿ƒç‚¹**ï¼šçº¯ç™½ + ç²—ç»¿æ¡†ï¼ˆç¼–å·ï¼‰
                        if (coreTouch) {
                            ctx.fillStyle = 'white';
                            ctx.fillRect(px + pixelSize*0.05, py + pixelSize*0.05, pixelSize*0.9, pixelSize*0.9);

                            ctx.strokeStyle = 'lime';
                            ctx.lineWidth = Math.max(3, pixelSize * 0.4);
                            ctx.lineCap = 'round';
                            ctx.strokeRect(px + pixelSize*0.08, py + pixelSize*0.08, pixelSize*0.84, pixelSize*0.84);

                            // ç¼–å·æ ‡ç­¾ï¼ˆå°ï¼‰
                            ctx.fillStyle = 'lime';
                            ctx.font = `${pixelSize*0.6}px monospace`;
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(
                                Array.from(touches.keys()).indexOf(coreTouch.identifier)+1 + '',
                                px + pixelSize/2,
                                py + pixelSize/2
                            );
                        }
                    }
                }
            }
        }

        // äº‹ä»¶ï¼šTouch å…¨æ”¯æŒ
        canvas.addEventListener('touchstart', updateTouches, { passive: false });
        canvas.addEventListener('touchmove', updateTouches, { passive: false });
        canvas.addEventListener('touchend', updateTouches, { passive: false });
        canvas.addEventListener('touchcancel', updateTouches, { passive: false });

        // Mouse æµ‹è¯•ï¼ˆå•ç‚¹ï¼‰
        canvas.addEventListener('mousemove', (e) => {
            touches.clear();
            const x = ((e.clientX - offsetX)) / pixelSize;
            const y = ((e.clientY - offsetY)) / pixelSize;
            touches.set(999, {
                x, y, gridX: Math.floor(x), gridY: Math.floor(y),
                force: 1, radius: 5, seed: 999
            });
            touchCountEl.textContent = 1;
            totalForceEl.textContent = '1.0';
            render();
        });
        canvas.addEventListener('mousedown', () => updateTouches({ touches: [] }));
        canvas.addEventListener('mouseup', () => {
            touches.clear(); touchCountEl.textContent = 0; totalForceEl.textContent = '0';
            render();
        });

        // è‡ªé€‚åº”
        window.addEventListener('resize', resize);
        window.addEventListener('orientationchange', () => setTimeout(resize, 100));
        resize();
        render();
    </script>
</body>
</html>
